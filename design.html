<!DOCTYPE html><html><head><title>Cats MTL: Design</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Typelevel contributors" /><meta name="description" content="Monad Transformers made easy" /><meta name="og:image" content="/cats-mtl/img/poster.png" /><meta name="image" property="og:image" content="/cats-mtl/img/poster.png" /><meta name="og:title" content="Cats MTL: Design" /><meta name="title" property="og:title" content="Cats MTL: Design" /><meta name="og:site_name" content="Cats MTL" /><meta name="og:url" content="https://typelevel.org/cats-mtl/" /><meta name="og:type" content="website" /><meta name="og:description" content="Monad Transformers made easy" /><link rel="icon" type="image/png" href="/cats-mtl/img/favicon.png" /><meta name="twitter:title" content="Cats MTL: Design" /><meta name="twitter:image" content="/cats-mtl/img/poster.png" /><meta name="twitter:description" content="Monad Transformers made easy" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/cats-mtl/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/cats-mtl/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/cats-mtl/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/cats-mtl/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/cats-mtl/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/cats-mtl/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/cats-mtl/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/cats-mtl/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/cats-mtl/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/cats-mtl/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/cats-mtl/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/cats-mtl/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/cats-mtl/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/cats-mtl/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/cats-mtl/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/cats-mtl/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/cats-mtl/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/cats-mtl/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/cats-mtl/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/cats-mtl/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/cats-mtl/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/cats-mtl/css/light-style.css" /></head><body class="page"><nav id="navigation" aria-labelledby="main-navigation"><div class="navbar-wrapper container"><div class="navigation-brand"><a href="/cats-mtl/" class="brand background-mask"><div class="page-icon-wrapper"></div><span class="brand-title">Cats MTL</span></a></div><div class="navigation-menu"><ul><li><a href="https://github.com/typelevel/cats-mtl" target="_blank" rel="noopener noreferrer"><i class="nav-item-icon fa fa-lg fa-github" hidden="true"></i><span class="nav-item-text">GitHub</span></a></li><li><a href="api"><i class="nav-item-icon fa fa-lg fa-file-text" hidden="true"></i><span class="nav-item-text">Scaladoc</span></a></li></ul></div></div></nav><nav class="menu-container" aria-labelledby="section-navigation"><div id="horizontal-menu"><ul class="horizontal-nav"><li><a class="" href="/cats-mtl/getting-started.html">Getting Started</a></li><li><a class="" href="/cats-mtl/mtl-classes.html">MTL Type Classes</a></li><li><a class="" href="/cats-mtl/migration.html">Migration Guide</a></li><li><a class=" active " href="/cats-mtl/design.html">Design</a></li></ul></div></nav><main id="site-main" class="page-site-main"><section class="use"><div class="container"><div id="content"><h1 id="cats-mtl-design">cats-mtl Design</h1>
<p>Overall, cats-mtl has similar design to cats: 
instances package, syntax package, implicits package.</p>

<p>There’s also a hierarchy package, because 
cats-mtl uses a different typeclass encoding
than cats to avoid implicit ambiguity.</p>

<p>The problem looks like this:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats._</span>

<span class="k">type</span> <span class="kt">Err</span>
<span class="k">type</span> <span class="kt">Log</span>

<span class="k">def</span> <span class="nf">f</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">MonadError</span><span class="o">[</span><span class="kt">?</span>, <span class="kt">Err</span><span class="o">]</span><span class="kt">:</span> <span class="kt">MonadWriter</span><span class="o">[</span><span class="kt">?</span>, <span class="kt">Log</span><span class="o">]]</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
      <span class="c1">// implicitly[Monad[F]] // ambiguity between derived monads from MonadError and MonadWriter</span>
      <span class="c1">// 1.pure[F].flatMap(_ =&gt; 1.raise) // same ambiguity affects MonadSyntax</span>
      <span class="o">()</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The cause is that the implicit conversions <code class="highlighter-rouge">MonadError[F, Err] =&gt; Monad[F]</code> and 
<code class="highlighter-rouge">MonadWriter[F, Log] =&gt; Monad[F]</code> are the same priority. If those conversions 
were different priorities, the issue would be fixed, and that’s exactly what cats-mtl’s encoding does.</p>

<p>Similarly to the <a href="https://github.com/aloiscochard/scato">Scato</a> project, instead of inheritance
the transformer classes in cats-mtl use aggregation. Mtl classes thus contain instances
of their superclasses.</p>

<h2 id="motivation">Motivation</h2>

<p>The motivation for cats-mtl’s existence can be summed up in a few points:</p>
<ul>
  <li>using subtyping to express typeclass subclassing results in implicit ambiguities,
and doing it another way would result in a massive inconsistency inside cats if only done for MTL classes.
for a detailed explanation, see Adelbert Chang’s article
<a href="http://typelevel.org/blog/2016/09/30/subtype-typeclasses.html">here</a>.</li>
  <li>most MTL classes do not actually require <code class="highlighter-rouge">Monad</code> as a constraint for their laws.
cats-mtl weakens this constraint to <code class="highlighter-rouge">Functor</code> or <code class="highlighter-rouge">Applicative</code> whenever possible,
with the result that there’s now a notion of a <code class="highlighter-rouge">Functor</code> transformer stack and 
<code class="highlighter-rouge">Applicative</code> transformer stack in addition to that of a <code class="highlighter-rouge">Monad</code> transformer stack.</li>
  <li>the most used operations on <code class="highlighter-rouge">MonadWriter</code> and <code class="highlighter-rouge">MonadReader</code> are <code class="highlighter-rouge">tell</code> and <code class="highlighter-rouge">ask</code>,
and the other operations severely restrict the space of implementations despite being
used much less. To fix this <code class="highlighter-rouge">Listen</code> and <code class="highlighter-rouge">Local</code> are subclasses
of <code class="highlighter-rouge">Tell</code> and <code class="highlighter-rouge">Ask</code>, which have only the essentials.</li>
</ul>

<p>The first point there means that it’s impossible for cats-mtl type classes
to expose their base class instances implicitly; for example <code class="highlighter-rouge">F[_]: Stateful[?[_], S]</code> isn’t enough
for a <code class="highlighter-rouge">Monad[F]</code> to be visible in implicit scope, despite <code class="highlighter-rouge">Stateful</code> containing a <code class="highlighter-rouge">Monad</code>
instance as a member. The root cause here is that prioritizing implicit conversions with subtyping
explicitly can’t work with cats and cats-mtl separate, as the <code class="highlighter-rouge">Monad[F]</code> instance for the type 
from cats will always conflict with a derived instance.</p>

<p>Thus <code class="highlighter-rouge">F[_]: Stateful[?[_], S]</code>, translated, becomes <code class="highlighter-rouge">F[_]: Monad: Stateful[?[_], S]</code>.</p>

<p>For some historical info on the origins of cats-mtl, see:</p>

<p><a href="https://github.com/typelevel/cats/issues/1210">https://github.com/typelevel/cats/issues/1210</a></p>

<p><a href="https://github.com/typelevel/cats/pull/1379">https://github.com/typelevel/cats/pull/1379</a></p>

<p><a href="https://github.com/typelevel/cats/pull/1751">https://github.com/typelevel/cats/pull/1751</a></p>

<h2 id="laws">Laws</h2>

<p>Type class laws come in a few varieties in cats-mtl: internal, external, and free.</p>

<p>Internal laws dictate how multiple operations inter-relate.
One side of the equation can always be reduced to a single function application of an operation.
These express “default” implementations that should be indistinguishable in result from the actual implementation.</p>

<p>External laws are laws that still need to be tested but don’t fall into the internal laws.</p>

<p>Free laws are (in theory) unnecessary to test, because they are implied by other laws and the 
types of the operations in question. There will usually be rudimentary proofs 
or some justification attached to make sure these aren’t just made up.</p>

</div></div></section></main><footer id="site-footer"><div class="container"><div class="row"><p>Cats MTL is designed and developed by <a href="https://typelevel.org/cats-mtl/" target="_blank" rel="noopener noreferrer">Typelevel contributors</a></p></div><div class="row"><div><p>Website built with <a href="https://47degrees.github.io/sbt-microsites/" target="_blank" rel="noopener noreferrer">sbt-microsites</a> - © 2019 <a href="https://www.47deg.com/" target="_blank" rel="noopener noreferrer">47 Degrees</a></p></div></div></div></footer><script src="/cats-mtl/highlight/highlight.pack.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'typelevel/cats-mtl'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/cats-mtl/js/version-selector.js"></script></body></html>