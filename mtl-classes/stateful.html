<!DOCTYPE html><html><head><title>Cats MTL: Stateful</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Typelevel contributors" /><meta name="description" content="Monad Transformers made easy" /><meta name="og:image" content="/cats-mtl/img/poster.png" /><meta name="image" property="og:image" content="/cats-mtl/img/poster.png" /><meta name="og:title" content="Cats MTL: Stateful" /><meta name="title" property="og:title" content="Cats MTL: Stateful" /><meta name="og:site_name" content="Cats MTL" /><meta name="og:url" content="https://typelevel.org/cats-mtl/" /><meta name="og:type" content="website" /><meta name="og:description" content="Monad Transformers made easy" /><link rel="icon" type="image/png" href="/cats-mtl/img/favicon.png" /><meta name="twitter:title" content="Cats MTL: Stateful" /><meta name="twitter:image" content="/cats-mtl/img/poster.png" /><meta name="twitter:description" content="Monad Transformers made easy" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/cats-mtl/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/cats-mtl/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/cats-mtl/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/cats-mtl/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/cats-mtl/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/cats-mtl/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/cats-mtl/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/cats-mtl/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/cats-mtl/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/cats-mtl/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/cats-mtl/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/cats-mtl/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/cats-mtl/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/cats-mtl/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/cats-mtl/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/cats-mtl/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/cats-mtl/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/cats-mtl/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/cats-mtl/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/cats-mtl/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/cats-mtl/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/cats-mtl/css/light-style.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/cats-mtl/" class="brand"><div class="brand-wrapper"></div><span>Cats MTL</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/cats-mtl/mtl-classes.html" title="MTL Type Classes" class="">MTL Type Classes</a></div> <div class="sidebar-nav-item  "><a href="/cats-mtl/mtl-classes/tell.html" title="Tell" class="">Tell</a></div> <div class="sidebar-nav-item  "><a href="/cats-mtl/mtl-classes/ask.html" title="Ask" class="">Ask</a></div> <div class="sidebar-nav-item active "><a href="/cats-mtl/mtl-classes/stateful.html" title="Stateful" class="active">Stateful</a></div> <div class="sidebar-nav-item  "><a href="/cats-mtl/mtl-classes/chronicle.html" title="Chronicle" class="">Chronicle</a></div> <div class="sidebar-nav-item  "><a href="/cats-mtl/mtl-classes/listen.html" title="Listen" class="">Listen</a></div> <div class="sidebar-nav-item  "><a href="/cats-mtl/mtl-classes/local.html" title="Local" class="">Local</a></div> <div class="sidebar-nav-item  "><a href="/cats-mtl/mtl-classes/raise.html" title="Raise" class="">Raise</a></div> <div class="sidebar-nav-item  "><a href="/cats-mtl/mtl-classes/handle.html" title="Handle" class="">Handle</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/typelevel/cats-mtl" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/typelevel/cats-mtl" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="typelevel" data-github-repo="cats-mtl"><div class="content-wrapper"><section><h2 id="stateful">Stateful</h2>

<p><code class="language-plaintext highlighter-rouge">Stateful[F, S]</code> describes the capability to read and write state values of type <code class="language-plaintext highlighter-rouge">S</code> inside the <code class="language-plaintext highlighter-rouge">F[_]</code> context.
This materializes in two functions <code class="language-plaintext highlighter-rouge">get: F[S]</code> and <code class="language-plaintext highlighter-rouge">set: S =&gt; F[Unit]</code> that are needed for <code class="language-plaintext highlighter-rouge">Stateful</code> instances:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">Stateful</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">S</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">get</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">S</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">set</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">S</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Simply spoken <code class="language-plaintext highlighter-rouge">Stateful</code> gives us the ability to thread state through computations in <code class="language-plaintext highlighter-rouge">F[_]</code>.
It provides access to controlled mutable state, which can be very useful, but must also be used with care.</p>

<p>There are dozens of use cases where it might make sense to use <code class="language-plaintext highlighter-rouge">Stateful</code>,
 one of them is to use it to maintain a cache when repeatedly accessing external services.
If we’ve already accessed a service with a given identifier, we can then access the cache instead, of course we also want the ability to invalidate the cache to receive fresh values as well.</p>

<p>Let’s say we have the following function to access a service:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats._</span>
<span class="k">import</span> <span class="nn">cats.data._</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">cats.mtl.Stateful</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">ServiceResult</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">companies</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>

<span class="k">def</span> <span class="nf">serviceCall</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Monad</span><span class="o">](</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">ServiceResult</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="c1">// a fake call to some external service, impure, so don't do this at home!</span>
  <span class="nf">println</span><span class="o">(</span><span class="n">show</span><span class="s">"Called service with $id"</span><span class="o">)</span>
  <span class="nc">ServiceResult</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nc">List</span><span class="o">(</span><span class="s">"Raven Enterprises"</span><span class="o">)).</span><span class="py">pure</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now, we want a new function that looks inside of a cache for the desired value and if it’s not there, access the service and put the result inside the cache.
To do so, we’ll make use of <code class="language-plaintext highlighter-rouge">Stateful</code> with a simple <code class="language-plaintext highlighter-rouge">Map[String, ServiceResult]</code> as our cache:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="kt">Cache</span> <span class="o">=</span> <span class="nc">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">ServiceResult</span><span class="o">]</span>

<span class="k">def</span> <span class="nf">cachedServiceCall</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Monad</span><span class="o">](</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Stateful</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Cache</span><span class="o">])</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">ServiceResult</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">cache</span> <span class="k">&lt;-</span> <span class="nv">F</span><span class="o">.</span><span class="py">get</span>
  <span class="n">result</span> <span class="k">&lt;-</span> <span class="nv">cache</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
              <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">result</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nv">result</span><span class="o">.</span><span class="py">pure</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
              <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="n">serviceCall</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">id</span><span class="o">)</span>
            <span class="o">}</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">result</span>
</code></pre></div></div>

<p>So far, so good, we’re successfully reading from the cache if it has the value we need, but it also doesn’t actually write anything into the cache when we call our service.
Let’s try again to write to the cache after making the service call.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">serviceCallAndWriteToCache</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Monad</span><span class="o">](</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Stateful</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Cache</span><span class="o">])</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">ServiceResult</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">result</span> <span class="k">&lt;-</span> <span class="n">serviceCall</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">id</span><span class="o">)</span>
  <span class="n">cache</span> <span class="k">&lt;-</span> <span class="nv">F</span><span class="o">.</span><span class="py">get</span>
  <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">F</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="nv">cache</span><span class="o">.</span><span class="py">updated</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">result</span><span class="o">))</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">result</span>
</code></pre></div></div>

<p>Lastly, we want to be able to invalidate our cache. This is fairly simple, as all we need to do is to use <code class="language-plaintext highlighter-rouge">set</code> with an empty cache:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">invalidate</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Stateful</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Cache</span><span class="o">])</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nv">F</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="nv">Map</span><span class="o">.</span><span class="py">empty</span><span class="o">)</span>
</code></pre></div></div>

<p>Now that we have our building blocks, we can now build a program that makes a few requests then invalidates the cache and makes another request:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">program</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Monad</span><span class="o">](</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Stateful</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Cache</span><span class="o">])</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">ServiceResult</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">result1</span> <span class="k">&lt;-</span> <span class="n">cachedServiceCall</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="s">"ab94d2"</span><span class="o">)</span>
  <span class="n">result2</span> <span class="k">&lt;-</span> <span class="n">cachedServiceCall</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="s">"ab94d2"</span><span class="o">)</span> <span class="c1">// This should use the cached value</span>
  <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">invalidate</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
  <span class="n">freshResult</span> <span class="k">&lt;-</span> <span class="n">cachedServiceCall</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="s">"ab94d2"</span><span class="o">)</span> <span class="c1">// This should access the service again</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">freshResult</span>
</code></pre></div></div>

<p>And we’re done, now, to be able to run this, we need to materialize our <code class="language-plaintext highlighter-rouge">program</code> into an actual value.
As the name suggests, <code class="language-plaintext highlighter-rouge">State</code> and <code class="language-plaintext highlighter-rouge">StateT</code> both allow us to use <code class="language-plaintext highlighter-rouge">Stateful</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">initialCache</span><span class="k">:</span> <span class="kt">Cache</span> <span class="o">=</span> <span class="nv">Map</span><span class="o">.</span><span class="py">empty</span>
<span class="c1">// initialCache: Cache = Map()</span>

<span class="nf">val</span> <span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">cache</span><span class="o">)</span> <span class="k">=</span> <span class="n">program</span><span class="o">[</span><span class="kt">State</span><span class="o">[</span><span class="kt">Cache</span>, <span class="kt">?</span><span class="o">]].</span><span class="py">run</span><span class="o">(</span><span class="n">initialCache</span><span class="o">).</span><span class="py">value</span>
<span class="c1">// Called service with ab94d2</span>
<span class="c1">// Called service with ab94d2</span>
<span class="c1">// Called service with ab94d2</span>
<span class="c1">// result: Map[String, ServiceResult] = Map()</span>
<span class="c1">// cache: ServiceResult = ServiceResult(</span>
<span class="c1">//   id = 0,</span>
<span class="c1">//   companies = List("Raven Enterprises")</span>
<span class="c1">// )</span>
</code></pre></div></div>

<p>As per usual, Cats-mtl provides <code class="language-plaintext highlighter-rouge">Stateful</code> instances for all monad transformer stacks where <code class="language-plaintext highlighter-rouge">StateT</code> appears.</p>
</section></div></div></div></div><script src="/cats-mtl/highlight/highlight.pack.js"></script><script src="/cats-mtl/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'typelevel/cats-mtl'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/cats-mtl/js/search.js"></script><script src="/cats-mtl/js/docs.js"></script></body></html>